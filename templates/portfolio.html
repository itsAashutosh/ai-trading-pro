<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Pro - Portfolio Analysis</title>
    
    <!-- Using Tailwind CSS for consistent styling with dashboard -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        /* Custom Styles matching Dashboard theme */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e5e7eb;
            min-height: 100vh;
            padding-top: 5rem;
        }

        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }

        /* Navbar Styles - matching dashboard */
        .navbar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(71, 85, 105, 0.5);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: #00f5ff;
            letter-spacing: 1px;
            margin-right: 1.5rem;
        }

        .nav-links {
            list-style: none;
            display: flex;
            margin: 0;
            padding: 0;
            flex-grow: 1;
        }

        .nav-links li a {
            color: #94a3b8;
            text-decoration: none;
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .nav-links li a:hover, .nav-links li a.active {
            color: #ffffff;
            background-color: rgba(71, 85, 105, 0.3);
        }
        
        .nav-links li a.active {
            border-bottom: 2px solid #00f5ff;
            color: #00f5ff;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.9rem;
            color: #cbd5e1;
            white-space: nowrap;
        }

        .market-status {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .market-closed {
            background-color: #ef4444;
            color: #fff;
        }

        .market-open {
            background-color: #10b981;
            color: #fff;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
        }

        .btn-primary {
            background-color: #00f5ff;
            color: #1f2937;
        }

        .btn-primary:hover {
            background-color: #00c7e6;
            transform: scale(1.05);
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Color classes for Price Change */
        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #00f5ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table Styles */
        .stock-table th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: #94a3b8;
            border-bottom: 1px solid #334155;
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        .stock-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #1e293b;
            font-size: 1rem;
        }

        .stock-table tbody tr:hover {
            background-color: rgba(51, 65, 85, 0.3);
        }

        /* Chart Container */
        .chart-container {
            height: 300px;
            position: relative;
        }

        /* 3D Visualization Container */
        #portfolio-3d {
            height: 350px;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        /* Loading state */
        .loading-inline {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #00f5ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="selection:bg-cyan-500 selection:text-black">
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="logo">AI TRADING PRO</div>
        <ul class="nav-links">
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="portfolio.html" class="active">Portfolio</a></li>
            <li><a href="trading.html">Trading</a></li>
            <li><a href="analytics.html">Analytics</a></li>
            <li><a href="news.html">News</a></li>
            <li><a href="rl_training.html">Train</a></li>
            <li><a href="settings.html">Settings</a></li>
        </ul>
        <div class="user-info">
            <span class="market-status market-closed" id="marketStatus">Market CLOSED</span>
            <span>Welcome, Demo User</span>
            <button class="btn btn-primary" onclick="logout()">LOGOUT</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h2 class="text-3xl font-extrabold text-white">
                Portfolio Analysis 
                <span class="loading-inline" id="mainLoader"></span>
            </h2>
            <p class="text-slate-400 mt-2">Comprehensive view of your investment portfolio with live data</p>
        </div>

        <!-- Portfolio Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-6">
                <div class="text-slate-400 text-sm mb-2">Total Portfolio Value</div>
                <div class="text-3xl font-bold text-white mb-1" id="totalValue">$0.00</div>
                <div class="text-sm" id="totalChange">Calculating...</div>
            </div>
            <div class="card p-6">
                <div class="text-slate-400 text-sm mb-2">Available Cash</div>
                <div class="text-3xl font-bold text-white mb-1">$15,670.25</div>
                <div class="text-sm text-slate-400">Ready to invest</div>
            </div>
            <div class="card p-6">
                <div class="text-slate-400 text-sm mb-2">Invested Amount</div>
                <div class="text-3xl font-bold text-white mb-1" id="investedAmount">$0.00</div>
                <div class="text-sm text-slate-400" id="investedPercent">0% of portfolio</div>
            </div>
            <div class="card p-6">
                <div class="text-slate-400 text-sm mb-2">Today's Change</div>
                <div class="text-3xl font-bold" id="todayChange">$0.00</div>
                <div class="text-sm" id="todayChangePercent">0%</div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="card p-4 text-center">
                <div class="text-slate-400 text-xs uppercase mb-2">Annualized Return</div>
                <div class="text-xl font-semibold positive">+14.8%</div>
            </div>
            <div class="card p-4 text-center">
                <div class="text-slate-400 text-xs uppercase mb-2">Sharpe Ratio</div>
                <div class="text-xl font-semibold text-white">1.34</div>
            </div>
            <div class="card p-4 text-center">
                <div class="text-slate-400 text-xs uppercase mb-2">Beta</div>
                <div class="text-xl font-semibold text-white">0.87</div>
            </div>
            <div class="card p-4 text-center">
                <div class="text-slate-400 text-xs uppercase mb-2">Max Drawdown</div>
                <div class="text-xl font-semibold negative">-8.2%</div>
            </div>
            <div class="card p-4 text-center">
                <div class="text-slate-400 text-xs uppercase mb-2">Win Rate</div>
                <div class="text-xl font-semibold positive">68%</div>
            </div>
            <div class="card p-4 text-center">
                <div class="text-slate-400 text-xs uppercase mb-2">Volatility</div>
                <div class="text-xl font-semibold text-white">18.5%</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-white mb-4 border-b border-slate-600 pb-2">Asset Allocation</h3>
                <div class="chart-container">
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-white mb-4 border-b border-slate-600 pb-2">Performance vs S&P 500</h3>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 3D Portfolio Visualization -->
        <div class="card p-6 mb-8">
            <h3 class="text-xl font-semibold text-white mb-4 border-b border-slate-600 pb-2">3D Portfolio Visualization</h3>
            <div id="portfolio-3d"></div>
        </div>

        <!-- Risk Assessment -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-6 text-center">
                <h4 class="text-slate-400 text-sm mb-2">Portfolio Risk</h4>
                <div class="text-2xl font-bold text-yellow-500 mb-1">Medium</div>
                <small class="text-slate-500">Based on volatility and correlation</small>
            </div>
            <div class="card p-6 text-center">
                <h4 class="text-slate-400 text-sm mb-2">Diversification Score</h4>
                <div class="text-2xl font-bold text-green-500 mb-1">85/100</div>
                <small class="text-slate-500">Well diversified across sectors</small>
            </div>
            <div class="card p-6 text-center">
                <h4 class="text-slate-400 text-sm mb-2">Concentration Risk</h4>
                <div class="text-2xl font-bold text-green-500 mb-1">Low</div>
                <small class="text-slate-500">No single position > 25%</small>
            </div>
            <div class="card p-6 text-center">
                <h4 class="text-slate-400 text-sm mb-2">Market Correlation</h4>
                <div class="text-2xl font-bold text-yellow-500 mb-1">0.73</div>
                <small class="text-slate-500">Moderately correlated to market</small>
            </div>
        </div>

        <!-- Current Holdings -->
        <div class="card p-6">
            <h3 class="text-xl font-semibold text-white mb-4 border-b border-slate-600 pb-2">Current Holdings (Live Data)</h3>
            <div class="overflow-x-auto">
                <table class="stock-table min-w-full divide-y divide-slate-700">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Company</th>
                            <th>Shares</th>
                            <th>Avg Cost</th>
                            <th>Current Price</th>
                            <th>Market Value</th>
                            <th>Gain/Loss</th>
                            <th>% of Portfolio</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="holdings-table" class="divide-y divide-slate-800">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 2rem;">
                                <div class="loader mx-auto"></div>
                                <p class="mt-4 text-slate-400">Loading live stock data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // API Keys
        const FINNHUB_API_KEY = 'd3f9q79r01qolknc9vhgd3f9q79r01qolknc9vi0';
        const FINNHUB_BASE_URL = 'https://finnhub.io/api/v1';

        // Portfolio holdings with purchase info
        const portfolio = [
            { symbol: 'AAPL', company: 'Apple Inc.', shares: 100, avgCost: 150.25 },
            { symbol: 'TSLA', company: 'Tesla Inc.', shares: 50, avgCost: 220.80 },
            { symbol: 'GOOGL', company: 'Alphabet Inc.', shares: 25, avgCost: 2800.40 },
            { symbol: 'MSFT', company: 'Microsoft Corp.', shares: 75, avgCost: 280.60 }
        ];

        let allocationChart = null;
        let performanceChart = null;
        let portfolioData = [];

        // Initialize Portfolio Page
        document.addEventListener('DOMContentLoaded', function() {
            updateMarketStatus();
            fetchLiveStockData();
            init3DVisualization();
            
            // Refresh data every 60 seconds
            setInterval(() => {
                updateMarketStatus();
                fetchLiveStockData();
            }, 60000);
        });

        function updateMarketStatus() {
            const statusElement = document.getElementById('marketStatus');
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();
            
            const isOpenDay = day >= 1 && day <= 5;
            const isOpenHour = hour >= 9 && hour < 16;

            if (isOpenDay && isOpenHour) {
                statusElement.textContent = 'Market OPEN';
                statusElement.classList.remove('market-closed');
                statusElement.classList.add('market-open');
            } else {
                statusElement.textContent = 'Market CLOSED';
                statusElement.classList.remove('market-open');
                statusElement.classList.add('market-closed');
            }
        }

        // Fetch live stock data from Finnhub
        async function fetchLiveStockData() {
            try {
                const promises = portfolio.map(async stock => {
                    try {
                        const response = await fetch(
                            `${FINNHUB_BASE_URL}/quote?symbol=${stock.symbol}&token=${FINNHUB_API_KEY}`
                        );
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        return {
                            ...stock,
                            currentPrice: data.c || 0,
                            change: data.d || 0,
                            changePercent: data.dp || 0,
                            previousClose: data.pc || 0
                        };
                    } catch (err) {
                        console.error(`Error fetching ${stock.symbol}:`, err);
                        return {
                            ...stock,
                            currentPrice: 0,
                            change: 0,
                            changePercent: 0,
                            previousClose: 0
                        };
                    }
                });

                portfolioData = await Promise.all(promises);
                updateHoldingsTable();
                updatePortfolioMetrics();
                initializeCharts();
                
                // Hide loader
                const loader = document.getElementById('mainLoader');
                if (loader) loader.style.display = 'none';
            } catch (error) {
                console.error('Error fetching portfolio data:', error);
                const loader = document.getElementById('mainLoader');
                if (loader) loader.style.display = 'none';
            }
        }

        function updateHoldingsTable() {
            const tbody = document.getElementById('holdings-table');
            let totalPortfolioValue = 0;

            const rows = portfolioData.map(stock => {
                const marketValue = stock.currentPrice * stock.shares;
                const totalCost = stock.avgCost * stock.shares;
                const gainLoss = marketValue - totalCost;
                const gainLossPercent = ((gainLoss / totalCost) * 100);
                
                totalPortfolioValue += marketValue;

                return `
                    <tr>
                        <td class="font-bold text-white">${stock.symbol}</td>
                        <td class="text-slate-300">${stock.company}</td>
                        <td>${stock.shares}</td>
                        <td>$${stock.avgCost.toFixed(2)}</td>
                        <td>$${stock.currentPrice.toFixed(2)}</td>
                        <td>$${marketValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="${gainLoss >= 0 ? 'positive' : 'negative'} font-semibold">
                            ${gainLoss >= 0 ? '+' : ''}$${gainLoss.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} 
                            (${gainLoss >= 0 ? '+' : ''}${gainLossPercent.toFixed(2)}%)
                        </td>
                        <td id="percent-${stock.symbol}">0%</td>
                        <td><button class="btn btn-primary btn-small" onclick="tradeStock('${stock.symbol}')">Trade</button></td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;

            // Update percentages after total is calculated
            const cash = 15670.25;
            const totalWithCash = totalPortfolioValue + cash;
            portfolioData.forEach(stock => {
                const marketValue = stock.currentPrice * stock.shares;
                const percent = ((marketValue / totalWithCash) * 100).toFixed(1);
                const percentCell = document.getElementById(`percent-${stock.symbol}`);
                if (percentCell) {
                    percentCell.textContent = `${percent}%`;
                }
            });
        }

        function updatePortfolioMetrics() {
            const cash = 15670.25;
            let totalInvested = 0;
            let totalCost = 0;
            let todayChange = 0;

            portfolioData.forEach(stock => {
                const marketValue = stock.currentPrice * stock.shares;
                const costBasis = stock.avgCost * stock.shares;
                const dayChange = stock.change * stock.shares;
                
                totalInvested += marketValue;
                totalCost += costBasis;
                todayChange += dayChange;
            });

            const totalValue = totalInvested + cash;
            const totalGainLoss = totalInvested - totalCost;
            const totalGainLossPercent = ((totalGainLoss / totalCost) * 100);
            const todayChangePercent = ((todayChange / (totalInvested - todayChange)) * 100);
            const investedPercent = ((totalInvested / totalValue) * 100);

            // Update DOM
            document.getElementById('totalValue').textContent = `$${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            const totalChangeEl = document.getElementById('totalChange');
            totalChangeEl.textContent = `${totalGainLoss >= 0 ? '+' : ''}$${totalGainLoss.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${totalGainLoss >= 0 ? '+' : ''}${totalGainLossPercent.toFixed(2)}%)`;
            totalChangeEl.className = totalGainLoss >= 0 ? 'text-sm positive' : 'text-sm negative';

            document.getElementById('investedAmount').textContent = `$${totalInvested.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('investedPercent').textContent = `${investedPercent.toFixed(1)}% of portfolio`;

            const todayChangeEl = document.getElementById('todayChange');
            todayChangeEl.textContent = `${todayChange >= 0 ? '+' : ''}$${Math.abs(todayChange).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            todayChangeEl.className = `text-3xl font-bold ${todayChange >= 0 ? 'positive' : 'negative'}`;

            const todayChangePercentEl = document.getElementById('todayChangePercent');
            todayChangePercentEl.textContent = `${todayChange >= 0 ? '+' : ''}${todayChangePercent.toFixed(2)}%`;
            todayChangePercentEl.className = `text-sm ${todayChange >= 0 ? 'positive' : 'negative'}`;
        }

        function initializeCharts() {
            // Asset Allocation Chart
            const allocationCtx = document.getElementById('allocationChart');
            if (allocationCtx) {
                const cash = 15670.25;
                const labels = [...portfolioData.map(s => s.symbol), 'Cash'];
                const data = [...portfolioData.map(s => s.currentPrice * s.shares), cash];
                
                if (allocationChart) {
                    allocationChart.destroy();
                }

                allocationChart = new Chart(allocationCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#00f5ff',
                                '#ff00ff',
                                '#ffff00',
                                '#10b981',
                                '#ef4444'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#e5e7eb',
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart');
            if (performanceCtx && !performanceChart) {
                performanceChart = new Chart(performanceCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'],
                        datasets: [
                            {
                                label: 'Your Portfolio',
                                data: [0, 5.2, 3.1, 8.7, 15.4, 18.2, 22.1, 20.3, 25.4],
                                borderColor: '#00f5ff',
                                backgroundColor: 'rgba(0, 245, 255, 0.1)',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'S&P 500',
                                data: [0, 2.1, 1.8, 4.2, 8.7, 10.1, 12.4, 11.8, 14.2],
                                borderColor: '#ff00ff',
                                backgroundColor: 'rgba(255, 0, 255, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e5e7eb',
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(71, 85, 105, 0.3)' }
                            },
                            y: {
                                ticks: { 
                                    color: '#94a3b8',
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { color: 'rgba(71, 85, 105, 0.3)' }
                            }
                        }
                    }
                });
            }
        }

        function init3DVisualization() {
            try {
                const container = document.getElementById('portfolio-3d');
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                
                renderer.setSize(container.offsetWidth, container.offsetHeight);
                renderer.setClearColor(0x000000, 0);
                container.appendChild(renderer.domElement);

                // Update function for live data
                window.update3DVisualization = function() {
                    while(scene.children.length > 0){ 
                        scene.remove(scene.children[0]); 
                    }

                    const holdings = portfolioData.map((stock, idx) => ({
                        symbol: stock.symbol,
                        value: stock.currentPrice * stock.shares,
                        color: [0x00f5ff, 0xff00ff, 0xffff00, 0x10b981][idx] || 0xef4444
                    }));

                    holdings.push({ symbol: 'Cash', value: 15670.25, color: 0x10b981 });

                    const maxValue = Math.max(...holdings.map(h => h.value));
                    
                    holdings.forEach((holding, index) => {
                        const height = (holding.value / maxValue) * 4;
                        const geometry = new THREE.CylinderGeometry(0.4, 0.4, height, 8);
                        const material = new THREE.MeshBasicMaterial({ color: holding.color });
                        const cylinder = new THREE.Mesh(geometry, material);
                        
                        cylinder.position.x = (index - holdings.length / 2) * 1.5;
                        cylinder.position.y = height / 2;
                        
                        scene.add(cylinder);

                        // Add labels
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = 128;
                        canvas.height = 64;
                        context.fillStyle = 'white';
                        context.font = '16px Arial';
                        context.textAlign = 'center';
                        context.fillText(holding.symbol, 64, 32);
                        
                        const texture = new THREE.CanvasTexture(canvas);
                        const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
                        const sprite = new THREE.Sprite(spriteMaterial);
                        sprite.position.x = cylinder.position.x;
                        sprite.position.y = height + 1;
                        sprite.scale.set(1, 0.5, 1);
                        
                        scene.add(sprite);
                    });
                };

                camera.position.z = 6;
                camera.position.y = 2;

                function animate() {
                    requestAnimationFrame(animate);
                    scene.rotation.y += 0.005;
                    renderer.render(scene, camera);
                }
                animate();

                // Handle window resize
                window.addEventListener('resize', () => {
                    if (container.offsetWidth && container.offsetHeight) {
                        camera.aspect = container.offsetWidth / container.offsetHeight;
                        camera.updateProjectionMatrix();
                        renderer.setSize(container.offsetWidth, container.offsetHeight);
                    }
                });

                // Update 3D when data loads
                setTimeout(() => {
                    if (portfolioData.length > 0 && window.update3DVisualization) {
                        window.update3DVisualization();
                    }
                }, 3000);

            } catch (error) {
                console.warn('3D visualization failed to load:', error);
                document.getElementById('portfolio-3d').innerHTML = '<div style="padding: 2rem; text-align: center; color: #94a3b8;">3D visualization unavailable</div>';
            }
        }

        function tradeStock(symbol) {
            console.log(`Navigate to trading page for ${symbol}`);
            // window.location.href = `trading.html?symbol=${symbol}`;
        }

        function logout() {
            console.log('User logged out. (Placeholder for real logout functionality)');
            // In a real application, handle session clearing and redirection here
        }
    </script>
</body>
</html>